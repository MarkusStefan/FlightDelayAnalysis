---
title: "Flight Delay Analysis"
author: "by Markus"
date: "`r Sys.Date()`"
output:
  github_document:
    html_preview: FALSE
    fig_width: 5
    fig_height: 5
    #dev: jpeg
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



## Introduction

This project is intended to demonstrate the skills acquired from the Google Data Analytics Certificate Course hosted on Coursera. The dataset was retrived from [Kaggle](%22https://www.kaggle.com/datasets/undersc0re/flight-delay-and-causes/metadata?select=Flight_delay.csv%22). Originally, the dataset comes form the [U.S. Department of Transportation's (DOT) Bureau of Transportation Statistics (BTS)](https://www.bts.gov/).

The attempt to analyze the data set in a Spreadsheet (Excel) failed due to its high volume.
I personally decided to use R over SQL because R is more functional and also allows me to
visualize the data.


## General Analysis

### Data Preparation

#### **1** Loading the required packages for the analysis 

If the packages are not installed yet, use the install.packages() function first!

```{r eval=FALSE, include=TRUE}
library(tidyverse)
library(janitor)
library(dplyr)
library(readr)
library(stringr)
library(lubridate)
library(ggcorrplot)
```

```{r eval=TRUE, include=FALSE}
library(tidyverse)
library(janitor)
library(dplyr)
library(readr)
library(stringr)
library(lubridate)
library(ggcorrplot)
```


#### **2** Opening the dataset 
```{r eval=TRUE, include=FALSE}
#local_path <- ".../Flight_delay.csv"
local_path <- "/Users/markuskofler/Google Data Analytics/Portfolio Project/Flight_delay.csv"
#local_path_windows_os <- "~/A R_scripts/project/Flight_delay.csv"
flights_df <- read_csv(local_path)
```
```{r eval=False, include=True}
local_path <- ".../Flight_delay.csv"
flights_df <- read_csv(local_path_windows_os)
```
```{r echo=FALSE}
head(flights_df)
```
####**3** For the sake of visual appeal, I renamed the columnnames and converted them all to lowercase
```{r}
names(flights_df) <- tolower(names(flights_df %>% 
                                     rename(weekday = DayOfWeek,
                                            dep_time = DepTime,
                                           arr_time = ArrTime,
                                           scheduled_arr_time = CRSArrTime, 
                                           uniq_carrier_code = UniqueCarrier,
                                           flight_num = FlightNum,
                                           tail_num = TailNum,
                                           actual_flight_time_min = ActualElapsedTime,
                                           estimate_flight_time_min = CRSElapsedTime,
                                           air_time_min = AirTime,
                                           arr_delay = ArrDelay,
                                           dep_delay = DepDelay,
                                           dep_airport_code = Origin,
                                           dep_airport = Org_Airport,
                                           dest_airport_code = Dest,
                                           dest_airport = Dest_Airport,
                                           distance_miles = Distance, 
                                           landing_to_gate_min = TaxiIn,
                                           gate_to_takeoff_min =TaxiOut,
                                           cancellation_cause_code = CancellationCode,
                                           carrier_delay = CarrierDelay,
                                           weather_delay = WeatherDelay,
                                           nas_delay = NASDelay,
                                           security_delay = SecurityDelay,
                                           late_aircraft_delay = LateAircraftDelay)))

```
```{r echo=FALSE}
colnames(flights_df)
```
#### **4** Next, we remove columns that don't give us any information (due to a lack of data)

```{r}
vector <- c()
for (i in names(flights_df)) {
  if (is_double(flights_df[[i]][2]) == TRUE) {
    if (sum(flights_df[i]) == 0 ) {
      vector <- append(vector, i)
    }
  }
}
```
```{r echo=FALSE}
cat("the vector contains columns:", vector, sep="\n-")
```
#### **5** Removing the two unnecessary columns (2 methods)
```{r eval=FALSE, echo=TRUE}
#method 1: selecting all except from elements of vector
flights_df <- select(flights_df, -all_of(vector))
```
```{r}
#method 2: dropping useless columns
flights_df <- flights_df[!(names(flights_df) %in% vector)]
```
```{r echo=FALSE}
colnames(flights_df)
```
#### **6** Creating a new column that contains values of the total delay for each specific flight
```{r}
flights_df <- mutate(flights_df,
                     total_delay = (carrier_delay + weather_delay + nas_delay + 
                                    security_delay + late_aircraft_delay))
```
#### **7** Creating a new column that contains the month each individual flight took place
```{r}
library(lubridate)

flights_df <- flights_df %>% mutate(month = month(dmy(date)))
```
#### **8** Determining, in which delay category each flight falls 

classification according to the Federal Aviation Administration (FAA) that 
considers an actual arrival less than 15 min after the scheduled arrival as 
not delayed, an arrival between 15 and 45 min after the scheduled arrival as 
"medium delay" and beyond 45 min as "large delay".
Source: [Wikipedia](https://en.wikipedia.org/wiki/Flight_cancellation_and_delay#:~:text=A%20flight%20delay%20is%20when,all%20for%20a%20certain%20reason)
```{r}
vec <- c()
for (t in flights_df$total_delay) {
  if (t <= 15) {
    vec <- append(vec, "No delay")
  }
  if (t >= 45) {
    vec <- append(vec, "Large delay")
  }
  else {
    vec <- append(vec, "Medium delay")
  }
}
```
```{r echo=FALSE}
vec[1:21]
```
#### **9** creating a new column from the vector containing the categorization of each flight
```{r}
flights_df["delay_degree"] <- vec
```
```{r echo=FALSE}
colnames(flights_df)
```


#### **10** This step is mainly for the sake of(this case does not apply to the US since it is an EU law):
creating a new column which states whether the passenger are potentially subject 
to compensation according to EU261 law. 
Passengers are eligible to claim up to 600€ 
as soon as the flight is delayed for 3 hours, and receive a full refund,
if delayed for 5 hours or longer.
```{r}
vect <- c()
for (c in flights_df$total_delay){
  if (c < 180){
    vect <- append(vect, "no compensation")
  }
  if (c >= 300){
    vect <- append(vect, "full refund")
  }
  else {
    vect <- append(vect, "up to 600€")
  }
}
```


## Data Exploration

#### **11** Let's compute, which airline has the most delay time in the given 
time frame

```{r}
flights_df %>% 
  group_by(airline) %>% 
  drop_na() %>% 
  summarize(delay = sum(total_delay)) %>% 
  arrange(-delay)
```
So far, so good. But simply concluding that Southwest Airline Co. 
is the least reliable Airline would be false since Southwest operates the most 
flights in the given time period. 

To demonstrate this, let's display the number of flights of each individual airline:
```{r}
ggplot(flights_df) +
  geom_bar(aes(x = airline)) +
  theme(axis.text.x = element_text(angle = 35, hjust = 1)) +
  facet_wrap(~month)
```

A better measure would be the average delay for
each airline.

```{r}
flights_df %>% 
  group_by(airline) %>% 
  drop_na() %>% 
  summarize(delay = mean(total_delay)) %>% 
  arrange(-delay)
```



```{r eval=FALSE, include=FALSE}

#counting specific values in one row
#1st method:
sum(flights_df$airline == "United Air Lines Inc.")

sum(flights_df$airline == "United Air Lines Inc." |
    flights_df$airline == "Southwest Airlines Co.")

#2nd method: 
length(which(flights_df$carrier_delay > 30))

sum(flights_df$month > 4)


# plotting the most frequent airlines

#

#nrow(flights_df["airline"]=="Southwest Airlines Co." ) doesn't work !!!


avg <- flights_df %>% 
  group_by(airline) %>% 
  drop_na() %>% 
  summarize(delay = mean(total_delay)) 
avg

q <- arrange(avg, -delay) #arranging data doesn't work for ordering the bars

#bar graph of average delay per airline
ggplot(data=q) +
  geom_col(aes(x = factor(airline, delay), y = delay, fill = airline), width = 0.6) +
  theme(axis.text.x = element_blank()) + #, axis.text.x = element_text(angle = 35, hjust = 1)) 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#by using stat="identity", we can pass in x & y axis!

startdate <-  min(flights_df$date)
enddate <-  max(flights_df$date)

ggplot(data=avg) +
  geom_bar(aes(x = reorder(airline, -delay), y = delay, fill = airline), 
           stat = "identity", width = 0.6) +
  labs(title = "Average Delay per Airline", subtitle = paste("From", startdate, "to", enddate),
       caption = "by Markus Köfler", x = "Airlines", y = "Average Delay (min)") +
  theme(axis.text.x = element_blank()) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 


#displaying the average delay of each airline for each month               

ag <- flights_df %>% 
  group_by(airline, month) %>% 
  drop_na() %>% 
  summarize(delay = mean(total_delay)) 

print(ag, n=1000)


ggplot(data=ag) +
  geom_bar(aes(x = reorder(airline, -delay), y = delay, fill = airline), 
           stat = "identity", width = 0.6) +
  labs(title = "Average Delay per Airline", subtitle = paste("From", startdate, "to", enddate),
       caption = "by Markus Köfler", x = "Airlines", y = "Average Delay (min)") +
  theme(axis.text.x = element_blank()) + 
  theme(axis.text.x = element_text(angle = 70, hjust = 1)) +
  facet_wrap(~month)
  
  "we see that in June, Alaska Airlines has 0 min avg delay. Let's check, if they really
   can boast with no delay in June:"

w <- filter(flights_df, airline=="Alaska Airlines Inc." & month==6)

View(w)
"no values are returned, meaning that there are no observations for June for Alaska Airlines"

length(vec)
#creating a new column "delay_degree" which states how the delay can be classified



#flights_df$delay_degree <- vec
flights_df["delay_degree"] <- c(1:484551)
colnames(flights_df)



#filtering for columns that are numeric only !

flights_numeric <- select_if(flights_df, is.numeric)


# Computing correlation matrix
cor_matrix <- round(cor(flights_numeric),3)

# Computing correlation matrix with 
# p-values
corrp.mat <- cor_pmat(flights_numeric)
corrp.mat

# Visualizing and reordering correlation
# matrix
ggcorrplot(cor_matrix, hc.order =FALSE,
           outline.color ="#FFCFFF") + labs(title= "Correlation Matrix") +
           theme(plot.title = element_text(size = 25, hjust = 0.5)) 




#relationship between delay and flight duration/ distance (do longer trips mean a longer expected delay?)

ggplot(flights_df) +
  geom_jitter(aes(distance_miles, total_delay)) +
  geom_smooth(aes(distance_miles, total_delay), color = "red") + 
  facet_wrap(~airline) +  #adding the overall correlation of the two variables to each individual facet
  annotate(geom="text", x=3000, y=1100, 
                                   label= toString(cor(flights_df$distance_miles, 
                                   flights_df$total_delay, method = "pearson")), 
                                   color="blue",
                                   fontface="italic", size=2.5, angle=0)
                       
cor(flights_df$distance_miles, flights_df$total_delay, method = "pearson")



ggplot(short_flght) +
  geom_jitter(aes(distance_miles, total_delay, alpha=total_delay), color = "navy") +
  geom_smooth(aes(distance_miles, total_delay), color = "red", method = "lm") + 
  facet_wrap(~airline, scale = "free") + #adjusted x- and y-axis 
  stat_cor(aes(distance_miles, total_delay),color = "red", geom = "label", fill = "transparent") +
  labs(title = "Corellation between Flight Distance and Total Delay", subtitle = "Individual Airlines",
       caption = "by Markus Köfler", x = "Distance (miles)", y = "Delay (min)") +
  theme(axis.text.x = element_text(angle = 20, hjust = 1)) 
 



                       
```



```{r eval=FALSE, include=FALSE}

"______PLOTTING____________________________________________________"
#total delay
flights_df %>% 
  group_by(airline) %>% 
  drop_na() %>% 
  summarize(delay = sum(total_delay)) %>% 
  arrange(-delay)

#average delay per airline
flights_df %>% 
  group_by(airline) %>% 
  drop_na() %>% 
  summarize(delay = mean(total_delay)) %>% 
  arrange(-delay)



#data <- replace(flights_df$CancellationCode, flights_df$CancellationCode == "N", FALSE)
#flights_df$CancellationCode[flights_df$CancellationCode == "N"] <- FALSE



flights_df %>% select(CancellationCode)

flights_df %>% 
  select(cancellation_cause_code) %>% 
  group_by(cancellation_cause_code) %>% 
  drop_na()



#counting specific values in one row
#1st method:
sum(flights_df$airline == "United Air Lines Inc.")

sum(flights_df$airline == "United Air Lines Inc." |
    flights_df$airline == "Southwest Airlines Co.")

#2nd method: 
length(which(flights_df$carrier_delay > 30))

sum(flights_df$month > 4)

glimpse(flights_df)

# plotting the most frequent airlines

ggplot(flights_df) +
  geom_bar(aes(x = airline)) 
  


#classification of level of delay 

#Federal Aviation Administration (FAA) considers an actual 
#arrival later than 15 min after the scheduled arrival as delayed
#source https://en.wikipedia.org/wiki/Flight_cancellation_and_delay#:~:text=A%20flight%20delay%20is%20when,all%20for%20a%20certain%20reason.

vec <- c()
for (t in flights_df$total_delay) {
  if (t <= 15) {
    vec <- append(vec, "No delay")
  }
  if (t >= 45) {
    vec <- append(vec, "Large delay")
  }
  else {
    vec <- append(vec, "Medium delay")
  }
}
vec 

length(vec)
#creating a new column "delay_degree" which states how the delay can be classified



#flights_df$delay_degree <- vec
flights_df["delay_degree"] <- c(1:484551)
colnames(flights_df)


View(flights_df)

#creating a new column "compensation" which states whether the passengers are potentially 
# subject to compensation according to EU261 law

vect <- c()
for (c in flights_df$total_delay){
  if (c < 180){
    vect <- append(vect, "no compensation")
  }
  if (c > 300){
    vect <- append(vect, "full refund")
  }
  else {
    vect <- append(vect, "up to 600€")
  }
}



#nrow(flights_df["airline"]=="Southwest Airlines Co." ) doesn't work !!!


avg <- flights_df %>% 
  group_by(airline) %>% 
  drop_na() %>% 
  summarize(delay = mean(total_delay)) 
avg

#bar graph of average delay per airline
ggplot(data=avg) +
  geom_col(aes(x = airline , y = delay , fill = airline), width = 0.6) +
  theme(axis.text.x = element_blank()) 
#  theme(axis.text.x = element_text(angle = 45, hjust = 1))




#testing df that is smaller... faster computing (RAM)
short_flght <-sqldf("SELECT * FROM flights_df LIMIT 30000")

glimpse(short_flght)

ggplot(short_flght) +
  geom_jitter(aes(distance_miles, total_delay, alpha=total_delay), color = "navy") +
  geom_smooth(aes(distance_miles, total_delay), color = "red", method = "lm") + 
  facet_wrap(~airline, scale = "free") + #adjusted x- and y-axis 
  stat_cor(aes(distance_miles, total_delay),color = "red", geom = "label", fill = "transparent") +
  labs(title = "Corellation between Flight Distance and Total Delay", subtitle = "Individual Airlines",
       caption = "by Markus Köfler", x = "Distance (miles)", y = "Delay (min)") +
  #theme(axis.text.x = element_blank()) + 
  theme(axis.text.x = element_text(angle = 20, hjust = 1)) 
 




startdate <-  min(flights_df$date)
enddate <-  max(flights_df$date)

ggplot(data=avg) +
  geom_bar(aes(x = reorder(airline, -delay), y = delay, fill = airline), 
           stat = "identity", width = 0.6) +
  labs(title = "Average Delay per Airline", subtitle = paste("From", startdate, "to", enddate),
       caption = "by Markus Köfler", x = "Airlines", y = "Average Delay (min)") +
  theme(axis.text.x = element_blank()) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 


#displaying the average delay of each airline for each month               

ag <- flights_df %>% 
  group_by(airline, month) %>% 
 # group_by(month) %>% 
  drop_na() %>% 
  summarize(delay = mean(total_delay)) 

ag

ggplot(data=ag) +
  geom_bar(aes(x = reorder(airline, -delay), y = delay, fill = airline), 
           stat = "identity", width = 0.6) +
  labs(title = "Average Delay per Airline", subtitle = paste("From", startdate, "to", enddate),
       caption = "by Markus Köfler", x = "Airlines", y = "Average Delay (min)") +
  theme(axis.text.x = element_blank()) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  facet_wrap(~month)
  
#filtering for columns that are numeric only !

flights_numeric <- select_if(flights_df, is.numeric)


# Computing correlation matrix
cor_matrix <- round(cor(flights_numeric),3)

# Computing correlation matrix with 
# p-values
corrp.mat <- cor_pmat(flights_numeric)
corrp.mat

# Visualizing and reordering correlation
# matrix
ggcorrplot(cor_matrix, hc.order =FALSE,
           outline.color ="#FFCFFF") + labs(title= "Correlation Matrix") +
           theme(plot.title = element_text(size = 25, hjust = 0.5)) 

#relationship between delay and flight duration/ distance (do longer trips mean a longer expected delay?)

ggplot(short_flght) +
  geom_jitter(aes(distance_miles, total_delay, alpha=total_delay), color = "navy") +
  geom_smooth(aes(distance_miles, total_delay), color = "red", method = "lm") + 
  facet_wrap(~airline, scale = "free") + #adjusted x- and y-axis 
  stat_cor(aes(distance_miles, total_delay),color = "red", geom = "label", fill = "transparent") +
  labs(title = "Corellation between Flight Distance and Total Delay", subtitle = "Individual Airlines",
       caption = "by Markus Köfler", x = "Distance (miles)", y = "Delay (min)") +
  theme(axis.text.x = element_text(angle = 20, hjust = 1)) 


                       
                       
```









## The Business Task

1) A business consultancy company is sending their consultants to their customers within the US area (domestic flights). The head of the HR team wants to know what are the most reliable airlines, what airports cause the most frequent and longest delays and cause the most frequent and logest delays in order to cut costs and minimize travel times for employees.

2) While working on the analysis, the CEO wants to find out [clients should be served on time ]

3) The consultancy company is located in Chicago (IL), Austin (TX), Denver (CL) , Jersey City (NJ) and Seattle (WA)























## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
